---
title: "Add Usage"
description: "Public API for ingesting Usage events for billing and metering."
---

# ➕ Add Usage

This API allows clients to report usage events to the billing system for processing and aggregation. These events are grouped and priced based on contract configuration and usage drivers.

---

## 📥 Endpoint

**GET** `https://www.data.valyx.com/usage`

---

### 📤  `curl` Request

```bash
curl -X 'POST' \
  'http://localhost:8181/usage' \
  -H 'accept: application/json' \
  -H 'X-Company-ID: 1234567890' \
  -H 'Content-Type: application/json' \
  -d '{
  "buyerId": "buyer_001",
  "contractId": "contract_abc123",
  "count": 1,
  "eventId": "event_xyz987",
  "eventTimestamp": 1721554567,
  "quantity": 150.5,
  "tags": {
    "region": "us-west",
    "service": "data-processing",
    "tier": "enterprise"
  },
  "usageDriverId": "usage_driver_basic",
  "usageReferenceId": "batch_2025_07_21_01"
}'
```

---


``` Type-1
{
  "eventId": "evt_001",
  "usageDriverId": "driver_456",
  "buyerId": "buyer_789",
  "usageReferenceId": "ref_001",
  "quantity": 100.5,
  "count": 1,
  "eventTimestamp": 1721546092,
  "tags": {
    "region": "ap-south-1",
    "business_type": "startup"
  },
  "contractId": "contract_xyz"
}
```


``` Type-2
{
  "eventId": "event_xyz987",
  "usageDriverId": "usage_driver_basic",
  "buyerId": "buyer_001",
  "usageReferenceId": "batch_2025_07_21_01",
  "quantity": 150.5,
  "count": 1,
  "eventTimestamp": 1721554567,
  "tags": {
    "region": "us-west",
    "service": "data-processing",
    "tier": "enterprise"
  },
}
```

---

### 🧾 Fields

| Field              | Type             | Required | Description                                                                                                       |
| ------------------ | ---------------- | -------- | ----------------------------------------------------------------------------------------------------------------- |
| `eventId`          | `string`         | ❌        | Unique identifier for the usage event. If not provided, it will be generated by the server.                       |
| `usageDriverId`    | `string`         | ✅        | Determines how usage is measured (e.g., by quantity or count).                                                    |
| `buyerId`          | `string`         | ✅        | Unique identifier for the buyer; used to look up the customer ID from the internal database.                      |
| `usageReferenceId` | `string`         | ✅        | Used to group multiple usage events together. Events with the same `usageReferenceId` are aggregated for pricing. |
| `quantity`         | `float`          | ✅        | The amount of usage (e.g., GBs used, API calls made).                                                             |
| `count`            | `float`          | ✅        | The number of discrete events (e.g., user signups).                                                               |
| `eventTimestamp`   | `int64 (Unix)`   | ✅        | Time of the event in UTC as a Unix timestamp (seconds).                                                           |
| `tags`             | `object<string>` | ✅        | Key-value pairs for tagging usage (e.g., `"region": "ap-south-1"`).                                               |
| `contractId`       | `string`         | ❌        | Optional. If absent, it is inferred from `buyerId` and `companyId`. Fails if multiple contracts are found.        |

---

#### ✅ Response (201 Created)

```json
{
  "buyerId": "buyer_001",
  "contractId": "contract_abc123",
  "count": 1,
  "eventId": "event_xyz987",
  "eventTimestamp": 1721554567,
  "quantity": 150.5,
  "tags": {
    "region": "us-west",
    "service": "data-processing",
    "tier": "enterprise"
  },
  "usageDriverId": "usage_driver_basic",
  "usageReferenceId": "batch_2025_07_21_01"
}
```

#### ❌ Error Responses

**400 Bad Request**

```json
{
  "error": "Invalid request body",
  "details": "json: cannot unmarshal number into Go struct field"
}
```

**500 Internal Server Error**

```json
{
  "error": "Failed to process usage data",
  "details": "contract ID is invalid or not found"
}
```

---

### ⚙️ Contract Resolution Logic

If `contractId` is not provided, the backend attempts to resolve it using the `buyerId` and associated `companyId`.

- If **multiple contracts** are found for that combination, the request will be **rejected**.
- This ensures that only one valid contract governs the pricing logic for each usage event.

---

### 🧠 Usage Reference Behavior

`usageReferenceId` is used to group related usage events together.

- Events sharing the **same** `usageReferenceId` are **aggregated together** to calculate a **combined price**.
- Events with **different** `usageReferenceId` values are **priced independently**, and their final charges are **added together**.

---

### ⚠️ Event ID Semantics

- `eventId` must be **globally unique**.
- If the same `eventId` is submitted **more than once**, only the **latest event** is retained.
- This ensures **idempotency** — allowing systems to re-submit or correct usage **without creating duplicates**.

---

### 🧪 Example Tags

```json
{
  "region": "us-east-1",
  "business_type": "enterprise",
  "feature": "api"
}
```

Tags help determine applicable rate cards and fee components during pricing.

---

### 📘 Notes

- The API is idempotent based on eventId.
- Use usageReferenceId for batch-level billing or to logically group usage activity.
- Invalid or unmatched tags will result in event rejection due to missing rate card linkage.
- Always ensure that eventTimestamp falls within the contract validity period.

---